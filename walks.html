<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estudio de Caminata Aleatoria — Standalone</title>
  <style>
    :root{
      --bg1:#eff6ff; --bg2:#eef2ff; --card:#fff; --muted:#6b7280;
      --accent:#2563eb; --good:#10b981; --danger:#ef4444; --glass:#f3f4f6;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(135deg,var(--bg1),var(--bg2)); padding:24px; box-sizing:border-box;}
    .container{max-width:980px;margin:0 auto;}
    .card{background:var(--card); border-radius:12px; box-shadow:0 6px 24px rgba(16,24,40,0.06); padding:20px; margin-bottom:16px;}
    h1,h2,h3{margin:0 0 8px 0;}
    .muted{color:var(--muted);}
    input[type="text"]{width:100%; padding:10px;border:1px solid #d1d5db;border-radius:8px;box-sizing:border-box;}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:8px;font-weight:600;}
    .btn-primary{background:var(--accent);color:white;}
    .btn-green{background:var(--good);color:white;}
    .btn-gray{background:#374151;color:white;}
    .center{text-align:center;}
    .row{display:flex;gap:12px;align-items:center;}
    .col{display:flex;flex-direction:column;gap:8px;}
    .small{font-size:13px;color:#4b5563;}
    .grid{display:grid;gap:12px;}
    .controls{display:flex;flex-direction:column;align-items:center;gap:8px;}
    .arrow-btn{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#10b981,#059669);color:white;font-weight:700;font-size:18px;}
    .arrow-row{display:flex;gap:8px;}
    .list-compact{max-height:200px;overflow:auto;border-top:1px solid #e6e6e6;padding-top:8px;}
    .chip{display:inline-flex;align-items:center;padding:6px 8px;border-radius:999px;font-weight:600;}
    canvas{display:block;margin:0 auto;border-radius:8px;background:transparent;}
    .footer-space{height:32px;}
    .muted-note{color:#6b7280;font-size:13px;}
    .inline-visual{display:flex;gap:8px;align-items:center;}
    .btn-link{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.08);padding:8px;border-radius:8px;}
    /* responsive */
    @media (max-width:640px){
      .arrow-btn{width:44px;height:44px}
      canvas{width:100%;height:auto}
    }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <script>
  (function(){
    // State (mirrors previous React state)
    const state = {
      stage: 'consent', // consent, input, instructions, walk, results
      name: '',
      consented: false,
      position: {x:0,y:0},
      path: [{x:0,y:0}],
      stepCount: 0,
      allWalks: [],
      randomWalk: [],
      currentRound: 1,
      showImport: false,
      isSaving: false
    };

    // Constants
    const maxSteps = 50;
    const totalRounds = 6;
    const blindStartRound = 4;
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwE4mbDhCdoFUQ8mp21lT8gyKE99LauMLB1A0ybuFgI544IOZo_a9HvVdAdaZSFAd1XiA/exec';

    // Root elements
    const root = document.getElementById('root');

    // Canvas (single element reused)
    let canvas, ctx;

    // Utils: icons as functions returning HTML
    function iconRotate(){ return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 11a8.1 8.1 0 0 0-15.5-2M4 13v6h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }
    function iconDatabase(){ return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><ellipse cx="12" cy="6" rx="8" ry="3" stroke="currentColor" stroke-width="1.6"/><path d="M4 6v6c0 1.657 3.582 3 8 3s8-1.343 8-3V6" stroke="currentColor" stroke-width="1.6"/><path d="M4 12v6c0 1.657 3.582 3 8 3s8-1.343 8-3v-6" stroke="currentColor" stroke-width="1.6" opacity="0.6"/></svg>'; }

    // Load saved walks from localStorage
    function loadSaved(){
      try{
        const stored = JSON.parse(localStorage.getItem('randomWalkData') || '[]');
        if(Array.isArray(stored)) state.allWalks = stored;
      }catch(e){
        console.warn('No stored walks or invalid JSON');
      }
    }

    // Save to localStorage
    function persistAllWalks(){
      try{
        localStorage.setItem('randomWalkData', JSON.stringify(state.allWalks));
      }catch(e){}
    }

    // Random walk generator for comparison
    function generateRandomWalk(){
      const walk = [{x:0,y:0}];
      let pos = {x:0,y:0};
      const directions = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
      for(let i=0;i<maxSteps;i++){
        const dir = directions[Math.floor(Math.random()*4)];
        pos = {x: pos.x + dir.x, y: pos.y + dir.y};
        walk.push({...pos});
      }
      return walk;
    }

    // Canvas drawing
    function ensureCanvas(){
      if(!canvas){
        canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 600;
        ctx = canvas.getContext('2d');
      }
    }

    function drawCanvas(){
      ensureCanvas();
      const scale = 20;
      const centerX = canvas.width/2;
      const centerY = canvas.height/2;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // grid
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      for(let i=-15;i<=15;i++){
        ctx.beginPath();
        ctx.moveTo(centerX + i*scale, 0);
        ctx.lineTo(centerX + i*scale, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, centerY + i*scale);
        ctx.lineTo(canvas.width, centerY + i*scale);
        ctx.stroke();
      }

      const isBlind = state.currentRound >= blindStartRound;

      // historical walks (if not blind)
      if(!isBlind){
        state.allWalks.forEach(walk=>{
          ctx.strokeStyle = 'rgba(100,116,139,0.18)';
          ctx.lineWidth = 2;
          ctx.beginPath();
          walk.path.forEach((p,i)=>{
            const x = centerX + p.x*scale;
            const y = centerY + p.y*scale;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          });
          ctx.stroke();
        });
      }

      // random walk (only in results)
      if(state.stage === 'results' && Array.isArray(state.randomWalk)){
        ctx.strokeStyle = 'rgba(239,68,68,0.6)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        state.randomWalk.forEach((p,i)=>{
          const x = centerX + p.x*scale;
          const y = centerY + p.y*scale;
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
      }

      // user's path
      ctx.strokeStyle = state.stage === 'results' ? '#3b82f6' : '#10b981';
      ctx.lineWidth = 3;
      ctx.beginPath();
      state.path.forEach((p,i)=>{
        const x = centerX + p.x*scale;
        const y = centerY + p.y*scale;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // current position dot
      if(state.path.length>0){
        const curr = state.path[state.path.length-1];
        ctx.fillStyle = state.stage === 'results' ? '#3b82f6' : '#10b981';
        ctx.beginPath();
        ctx.arc(centerX + curr.x*scale, centerY + curr.y*scale, 6, 0, 2*Math.PI);
        ctx.fill();
      }

      // center dot
      ctx.fillStyle = '#6b7280';
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, 2*Math.PI);
      ctx.fill();
    }

    // Movement handling
    function handleMove(dx,dy){
      if(state.stepCount >= maxSteps || state.isSaving || state.stage !== 'walk') return;
      const newPos = {x: state.position.x + dx, y: state.position.y + dy};
      state.position = newPos;
      state.path.push({...newPos});
      state.stepCount += 1;
      drawCanvas();
      if(state.path.length >= maxSteps) finishWalk();
      renderHeaderStepCountIfNeeded();
    }

    function renderHeaderStepCountIfNeeded(){
      // update any step counter displayed
      const elem = document.querySelector('#stepCounter');
      if(elem) elem.textContent = state.stepCount + ' / ' + maxSteps;
    }

    // Finish walk and save data
    async function finishWalk(){
      state.isSaving = true;
      render(); // to reflect "guardando"
      const walkData = {
        name: state.name,
        round: state.currentRound,
        timestamp: new Date().toISOString(),
        path: state.path.slice()
      };
      state.allWalks.push(walkData);
      persistAllWalks();
      // attempt to POST to Google Apps Script
      try{
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: new URLSearchParams({ payload: JSON.stringify(walkData) }).toString()
        });
        console.log('Datos enviados a Google Sheets (intentado).');
      }catch(err){
        console.warn('No se pudo enviar a Google Sheets:', err && err.message ? err.message : err);
      }
      state.randomWalk = generateRandomWalk();
      state.isSaving = false;
      state.stage = 'results';
      render();
    }

    // Reset session
    function reset(){
      state.stage = 'consent';
      state.name = '';
      state.consented = false;
      state.position = {x:0,y:0};
      state.path = [{x:0,y:0}];
      state.stepCount = 0;
      state.randomWalk = [];
      state.currentRound = 1;
      render();
    }

    // Next round
    function nextRound(){
      const next = state.currentRound + 1;
      if(next === blindStartRound && !state.name.includes(' (blind)')){
        state.name = state.name + ' (blind)';
      }
      state.position = {x:0,y:0};
      state.path = [{x:0,y:0}];
      state.stepCount = 0;
      state.randomWalk = [];
      state.currentRound = next;
      state.stage = 'instructions';
      render();
    }

    // Export & Import
    function exportData(){
      const dataStr = JSON.stringify(state.allWalks, null, 2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'datos_caminata_aleatoria_' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        try{
          const imported = JSON.parse(ev.target.result);
          if(!Array.isArray(imported)) throw new Error('Formato inválido (se esperaba array)');
          state.allWalks = imported;
          persistAllWalks();
          alert(imported.length + ' caminatas importadas exitosamente');
          state.showImport = false;
          render();
        }catch(err){
          alert('Error al importar datos. Asegúrate de que el archivo sea válido JSON de caminatas.');
          console.error(err);
        }
      };
      reader.readAsText(file);
    }

    // Keyboard controls active only during "walk"
    function onKeyDown(e){
      if(state.stage !== 'walk') return;
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        if(e.key === 'ArrowUp') handleMove(0,-1);
        if(e.key === 'ArrowDown') handleMove(0,1);
        if(e.key === 'ArrowLeft') handleMove(-1,0);
        if(e.key === 'ArrowRight') handleMove(1,0);
      }
    }

    // Helpers for results
    function calculateDistance(p){
      if(!Array.isArray(p) || p.length === 0) return '0.00';
      const final = p[p.length - 1] || {x:0,y:0};
      return Math.sqrt(final.x*final.x + final.y*final.y).toFixed(2);
    }

    // Render functions for each stage
    function render(){
      // remove/attach keyboard listener when needed
      if(state.stage === 'walk'){
        window.addEventListener('keydown', onKeyDown);
      }else{
        window.removeEventListener('keydown', onKeyDown);
      }

      // clear root
      root.innerHTML = '';

      if(state.stage === 'consent') return renderConsent();
      if(state.stage === 'input') return renderInput();
      if(state.stage === 'instructions') return renderInstructions();
      if(state.stage === 'walk') return renderWalk();
      if(state.stage === 'results') return renderResults();
    }

    function renderConsent(){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = '<h1>Estudio de Caminata Aleatoria</h1>';
      const inner = document.createElement('div');
      inner.className = 'card';
      inner.style.marginTop = '12px';
      inner.innerHTML = `
        <h3>Formulario de Consentimiento</h3>
        <div class="small" style="margin-top:8px">
          <p><strong>Propósito:</strong> Recopilar datos sobre caminata humana aleatoria y compararla con caminatas verosímiles generadas aleatoriamente. Tu participación es voluntaria y anónima; la caminata se almacenará con tu nombre.</p>
          <p><strong>Almacenamiento:</strong> El patrón se guarda localmente y se intenta enviar a una hoja de cálculo (si el experimentador ha configurado el destino).</p>
        </div>
      `;
      const chkRow = document.createElement('div');
      chkRow.style.display = 'flex';
      chkRow.style.alignItems = 'center';
      chkRow.style.gap = '12px';
      chkRow.style.marginTop = '12px';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = 'consentChk';
      input.checked = state.consented;
      input.addEventListener('change', e=>{
        state.consented = e.target.checked;
      });
      const label = document.createElement('label');
      label.htmlFor = 'consentChk';
      label.className = 'muted';
      label.textContent = 'He leído y acepto participar en este estudio';
      chkRow.appendChild(input);
      chkRow.appendChild(label);

      const buttonRow = document.createElement('div');
      buttonRow.style.marginTop = '12px';
      const btn = document.createElement('button');
      btn.className = 'btn-primary';
      btn.style.width = '100%';
      btn.textContent = 'Continuar';
      btn.disabled = !state.consented;
      input.addEventListener('change', ()=> btn.disabled = !input.checked);
      btn.addEventListener('click', ()=>{
        if(state.consented) {
          state.stage = 'input';
          render();
        }
      });
      buttonRow.appendChild(btn);

      inner.appendChild(chkRow);
      inner.appendChild(buttonRow);

      // import button for experimenter
      if(state.allWalks.length === 0 && !state.showImport){
        const impBtnWrap = document.createElement('div');
        impBtnWrap.style.marginTop = '10px';
        const impBtn = document.createElement('button');
        impBtn.className = 'btn-gray';
        impBtn.style.width = '100%';
        impBtn.textContent = 'Importar Datos Previos (Solo Experimentador)';
        impBtn.addEventListener('click', ()=>{
          state.showImport = true;
          render();
        });
        impBtnWrap.appendChild(impBtn);
        inner.appendChild(impBtnWrap);
      }

      if(state.showImport){
        const impDiv = document.createElement('div');
        impDiv.style.marginTop = '10px';
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.addEventListener('change', (e)=>{
          const file = e.target.files && e.target.files[0];
          importData(file);
        });
        impDiv.appendChild(fileInput);
        inner.appendChild(impDiv);
      }

      card.appendChild(inner);
      root.appendChild(card);
    }

    function renderInput(){
      const card = document.createElement('div');
      card.className = 'card';
      card.style.maxWidth = '560px';
      card.style.margin = '0 auto';
      card.innerHTML = '<h2>Información del Participante</h2>';
      const label = document.createElement('label');
      label.style.marginTop = '12px';
      label.className = 'small';
      label.textContent = 'Tu Nombre';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Ingresa tu nombre';
      input.value = state.name;
      input.addEventListener('input', e=> state.name = e.target.value);
      const btnWrap = document.createElement('div');
      btnWrap.style.marginTop = '12px';
      const btn = document.createElement('button');
      btn.className = 'btn-primary';
      btn.style.width = '100%';
      btn.textContent = 'Siguiente';
      btn.disabled = !state.name.trim();
      input.addEventListener('input', ()=> btn.disabled = !input.value.trim());
      btn.addEventListener('click', ()=>{
        if(state.name.trim()){
          state.stage = 'instructions';
          render();
        }
      });
      btnWrap.appendChild(btn);
      card.appendChild(label);
      card.appendChild(input);
      card.appendChild(btnWrap);
      root.appendChild(card);
    }

    function renderInstructions(){
      const isBlind = state.currentRound >= blindStartRound;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h2>Ronda ${state.currentRound} de ${totalRounds}${isBlind ? ' (ciega)' : ''}</h2>
        <h3>Instrucciones${isBlind ? ' (ciega)' : ''}</h3>
      `;
      const p = document.createElement('div');
      p.className = 'small';
      p.style.marginTop = '8px';
      p.innerHTML = `<p>Comenzarás desde el centro y tomarás <strong>50 pasos</strong> en cualquier dirección (arriba/abajo/izquierda/derecha). Intenta ser lo más aleatorio posible.</p>`;
      const note = document.createElement('p');
      note.className = 'small';
      note.style.marginTop = '8px';
      note.innerHTML = !isBlind ? `<span style="color:#2563eb">Verás las caminatas anteriores mientras te mueves.</span>` : `<span style="color:#d97706">En esta fase no se muestran caminatas anteriores ni datos de otros participantes.</span>`;
      const controls = document.createElement('p');
      controls.className = 'small';
      controls.innerHTML = `<p>Puedes usar:</p><ul class="small"><li>Las teclas de flecha</li><li>Los botones en pantalla</li></ul>`;
      const btnWrap = document.createElement('div');
      btnWrap.style.marginTop = '12px';
      const btn = document.createElement('button');
      btn.className = 'btn-green';
      btn.style.width = '100%';
      btn.textContent = 'Comenzar Caminata ' + state.currentRound;
      btn.addEventListener('click', ()=>{
        startWalk();
      });
      btnWrap.appendChild(btn);
      card.appendChild(p);
      card.appendChild(note);
      card.appendChild(controls);
      card.appendChild(btnWrap);
      root.appendChild(card);
    }

    function startWalk(){
      state.position = {x:0,y:0};
      state.path = [{x:0,y:0}];
      state.stepCount = 0;
      state.stage = 'walk';
      render();
    }

    function renderWalk(){
      const isBlind = state.currentRound >= blindStartRound;
      const topCard = document.createElement('div');
      topCard.className = 'card';
      topCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Ronda ${state.currentRound} de ${totalRounds}${isBlind ? ' (ciega)' : ''}</h2><div class="small"><strong>Pasos:</strong> <span id="stepCounter">${state.stepCount} / ${maxSteps}</span></div></div>`;
      const info = document.createElement('div');
      info.className = 'small';
      info.style.marginTop = '6px';
      info.textContent = 'Usa las teclas de flecha o los botones. ¡Intenta ser lo más aleatorio posible!';
      topCard.appendChild(info);
      if(!isBlind && state.allWalks.length > 0){
        const tip = document.createElement('div');
        tip.className = 'small';
        tip.style.marginTop = '6px';
        tip.style.color = '#4b5563';
        tip.textContent = 'Las líneas grises muestran caminatas anteriores.';
        topCard.appendChild(tip);
      }
      if(state.isSaving){
        const saving = document.createElement('div');
        saving.style.marginTop = '6px';
        saving.style.color = '#2563eb';
        saving.textContent = 'Guardando datos...';
        topCard.appendChild(saving);
      }
      root.appendChild(topCard);

      // canvas card
      const canvasCard = document.createElement('div');
      canvasCard.className = 'card';
      canvasCard.style.textAlign = 'center';
      ensureCanvas();
      canvasCard.appendChild(canvas);
      root.appendChild(canvasCard);
      drawCanvas();

      // controls
      const ctrlCard = document.createElement('div');
      ctrlCard.className = 'card';
      ctrlCard.style.display = 'flex';
      ctrlCard.style.flexDirection = 'column';
      ctrlCard.style.alignItems = 'center';
      ctrlCard.style.gap = '12px';

      const controls = document.createElement('div');
      controls.className = 'controls';
      const upBtn = document.createElement('button');
      upBtn.className = 'arrow-btn';
      upBtn.title = 'Arriba';
      upBtn.textContent = '↑';
      upBtn.addEventListener('click', ()=> handleMove(0,-1));
      const midRow = document.createElement('div'); midRow.className = 'arrow-row';
      const leftBtn = document.createElement('button'); leftBtn.className='arrow-btn'; leftBtn.title='Izquierda'; leftBtn.textContent='←'; leftBtn.addEventListener('click', ()=> handleMove(-1,0));
      const downBtn = document.createElement('button'); downBtn.className='arrow-btn'; downBtn.title='Abajo'; downBtn.textContent='↓'; downBtn.addEventListener('click', ()=> handleMove(0,1));
      const rightBtn = document.createElement('button'); rightBtn.className='arrow-btn'; rightBtn.title='Derecha'; rightBtn.textContent='→'; rightBtn.addEventListener('click', ()=> handleMove(1,0));
      midRow.appendChild(leftBtn); midRow.appendChild(downBtn); midRow.appendChild(rightBtn);

      controls.appendChild(upBtn);
      controls.appendChild(midRow);
      ctrlCard.appendChild(controls);
      root.appendChild(ctrlCard);
    }

    function renderResults(){
      const isBlind = state.currentRound >= blindStartRound;
      const userDistance = calculateDistance(state.path);
      const randomDistance = calculateDistance(state.randomWalk);
      const avgDistance = state.allWalks.length > 0 ? (state.allWalks.reduce((s,w)=> s + parseFloat(calculateDistance(w.path)),0) / state.allWalks.length).toFixed(2) : '0.00';

      const mainCard = document.createElement('div');
      mainCard.className = 'card';
      mainCard.innerHTML = `<h2>Resultados${isBlind ? ' (ciega)' : ''}</h2><p class="small">Así se compara tu caminata con una caminata aleatoria y, cuando corresponde, con participantes previos.</p>`;
      // three stat boxes
      const stats = document.createElement('div');
      stats.style.display = 'grid';
      stats.style.gridTemplateColumns = 'repeat(3,1fr)';
      stats.style.gap = '12px';
      stats.style.marginTop = '12px';
      const box1 = document.createElement('div'); box1.style.background='#eff6ff'; box1.style.padding='10px'; box1.style.borderRadius='8px'; box1.innerHTML = `<div class="small">Tu Distancia</div><div style="font-size:20px;font-weight:700;color:#2563eb">${userDistance}</div>`;
      const box2 = document.createElement('div'); box2.style.background='#fee2e2'; box2.style.padding='10px'; box2.style.borderRadius='8px'; box2.innerHTML = `<div class="small">Caminata Aleatoria</div><div style="font-size:20px;font-weight:700;color:#ef4444">${randomDistance}</div>`;
      const box3 = document.createElement('div'); box3.style.background='#f3f4f6'; box3.style.padding='10px'; box3.style.borderRadius='8px'; box3.innerHTML = `<div class="small">Promedio (Todos)</div><div style="font-size:20px;font-weight:700;color:#374151">${avgDistance}</div>`;
      stats.appendChild(box1); stats.appendChild(box2); stats.appendChild(box3);
      mainCard.appendChild(stats);

      // legend
      const legend = document.createElement('div');
      legend.style.marginTop = '12px';
      legend.style.display='flex';
      legend.style.gap='8px';
      legend.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center"><div style="width:12px;height:12px;background:#2563eb;border-radius:4px"></div><span class="small">Tu Caminata</span></div>
        <div style="display:flex;gap:8px;align-items:center"><div style="width:12px;height:12px;background:#ef4444;border-radius:4px"></div><span class="small">Caminata Aleatoria</span></div>
        ${!isBlind ? '<div style="display:flex;gap:8px;align-items:center"><div style="width:12px;height:12px;background:#9ca3af;border-radius:4px"></div><span class="small">Caminatas Anteriores</span></div>' : ''}
      `;
      mainCard.appendChild(legend);

      root.appendChild(mainCard);

      // canvas
      const canvasCard = document.createElement('div');
      canvasCard.className = 'card';
      ensureCanvas();
      canvasCard.appendChild(canvas);
      root.appendChild(canvasCard);
      drawCanvas();

      // collected data card + export
      if(!isBlind){
        const dataCard = document.createElement('div');
        dataCard.className = 'card';
        const header = document.createElement('div');
        header.style.display='flex';
        header.style.justifyContent='space-between';
        header.style.alignItems='center';
        const title = document.createElement('h3');
        title.style.display='flex';
        title.style.gap='8px';
        title.style.alignItems='center';
        title.innerHTML = iconDatabase() + ' Datos Recopilados (' + state.allWalks.length + ' caminatas)';
        header.appendChild(title);
        const actions = document.createElement('div');
        actions.style.display='flex';
        actions.style.gap='8px';
        const expBtn = document.createElement('button');
        expBtn.className='btn-gray';
        expBtn.innerHTML = iconDatabase() + ' Exportar';
        expBtn.addEventListener('click', exportData);
        actions.appendChild(expBtn);
        header.appendChild(actions);
        dataCard.appendChild(header);

        const list = document.createElement('div');
        list.className = 'list-compact';
        list.style.marginTop = '10px';
        if(state.allWalks.length === 0){
          const none = document.createElement('div');
          none.className = 'small';
          none.textContent = 'Aún no hay caminatas registradas.';
          list.appendChild(none);
        }else{
          state.allWalks.forEach((walk, idx)=>{
            const row = document.createElement('div');
            row.style.display='flex';
            row.style.justifyContent='space-between';
            row.style.padding='8px 0';
            row.style.borderBottom='1px solid #eee';
            const left = document.createElement('div');
            left.style.fontWeight='600';
            left.textContent = walk.name + ' (Ronda ' + walk.round + ')';
            const right = document.createElement('div');
            right.className='small';
            right.textContent = 'Dist: ' + calculateDistance(walk.path) + ' | ' + new Date(walk.timestamp).toLocaleString();
            row.appendChild(left);
            row.appendChild(right);
            list.appendChild(row);
          });
        }
        dataCard.appendChild(list);
        root.appendChild(dataCard);
      }

      // bottom actions: next round / done / reset
      const actionsCard = document.createElement('div');
      actionsCard.style.display='grid';
      actionsCard.style.gap='8px';
      if(state.currentRound < totalRounds){
        const contBtn = document.createElement('button');
        contBtn.className='btn-primary';
        contBtn.textContent = 'Continuar a Ronda ' + (state.currentRound+1) + (state.currentRound+1 >= blindStartRound ? ' (ciega)' : '');
        contBtn.addEventListener('click', nextRound);
        actionsCard.appendChild(contBtn);
      }else{
        const doneBox = document.createElement('div');
        doneBox.style.background = '#ecfdf5';
        doneBox.style.borderLeft = '4px solid #10b981';
        doneBox.style.padding='10px';
        doneBox.style.borderRadius='8px';
        doneBox.innerHTML = '<strong>¡Gracias por completar las ' + totalRounds + ' rondas!</strong>';
        actionsCard.appendChild(doneBox);
      }
      const resetBtn = document.createElement('button');
      resetBtn.className='btn-gray';
      resetBtn.innerHTML = iconRotate() + ' Iniciar Nueva Sesión de Participante';
      resetBtn.addEventListener('click', reset);
      actionsCard.appendChild(resetBtn);
      root.appendChild(actionsCard);
    }

    // initial load
    loadSaved();
    render();

    // expose some functions to window for debugging (optional)
    window.__randomWalkApp = {
      state,
      render,
      exportData,
      importData: (file) => importData(file)
    };
  })();
  </script>
</body>
</html>